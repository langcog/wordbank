---
title: "Accessing the Wordbank Database"
author: "Mika Braginsky and Dan Yurovsky"
date: "2015-04-25"
output:
  html_document:
    highlight: tango
    theme: spacelab
---

This script shows the basics of how to connect to the Wordbank database, load data from it, and work with that data. We illustrate this with two sample analyses: the first works with aggregate vocabulary size data and breaks down vocabulary development by the child's sex, and the second works with individual item data and looks at the trajectories of color words over age.

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(message=FALSE, warning=FALSE, cache=TRUE)
font = "Open Sans"
```

Load required libraries.
```{r, cache=FALSE}
library(dplyr)
library(directlabels)
library(RMySQL)
library(tidyr)
library(bootstrap)
library(ggplot2)
library(RCurl)
library(magrittr)
```

Get a script that provides interface functions for pulling data out of Wordbank.
```{r, cache=FALSE}
url <- 'https://raw.githubusercontent.com/langcog/wordbank/master/shiny_apps/data_loading.R'
script <- getURL(url, ssl.verifypeer = FALSE)
eval(parse(text = script))
```

Connect to the Wordbank database.
```{r, cache=FALSE}
wordbank <- src_mysql(dbname='wordbank', host="54.149.39.46", #"54.200.225.86",
                      user="wordbank", password="wordbank")
```

Get all the common tables.
```{r}
common.tables <- get.common.tables(wordbank)
```

Get all the instrument tables.
```{r}
instrument.tables <- get.instrument.tables(wordbank, common.tables$instrumentsmap)
```

Load in administration data.
```{r}
admins <- get.administration.data(common.tables$momed,
                                  common.tables$child,
                                  common.tables$instrumentsmap,
                                  common.tables$administration)
```

Number of administrations by sex for each instrument:
```{r, echo=FALSE}
admins.summary <- admins %>%
  group_by(language, form, sex) %>%
  summarise(n = n()) %>%
  filter(!is.na(sex), sex != "") %>%
  spread(sex, n) %>%
  rename(female = F,
         male = M) %>%
  mutate(total = female + male)

admins.total <- data.frame(language = "Total",
                           form = "",
                           female = sum(admins.summary$female),
                           male = sum(admins.summary$male),
                           total = sum(admins.summary$total))
admins.summary.total <- bind_rows(admins.summary, admins.total)

kable(admins.summary.total,
      #      col.names = c("language", "form", "female", "male", "total"),
      align = c("l", "c", "r", "r", "r"))
```

Load in item data.
```{r}
items <- get.item.data(common.tables$wordmapping,
                       common.tables$instrumentsmap,
                       common.tables$category)
```

Number of items by category for each instrument:
```{r, echo=FALSE}
items.summary <- items %>%
  group_by(language, form, type) %>%
  summarise(n = n()) %>%
  spread(type, n) %>%
  select(language, form, word, word_form, complexity) %>%
  mutate(word_form = ifelse(is.na(word_form), 0, word_form),
         complexity = ifelse(is.na(complexity), 0, complexity))

kable(items.summary,
      align = c("l", "c", "c", "c", "c"))
```

```{r, echo=FALSE}
#Functions for bootstrapping 95% confidence intervals.
na.median <- function(x) {median(x,na.rm=T)}
median.theta <- function(x,xdata,na.rm=T) {median(xdata[x],na.rm=na.rm)}
ci.median.low <- function(x,na.rm=T) {
  median(x,na.rm=na.rm) - 
    quantile(bootstrap(1:length(x),1000,median.theta,x,na.rm=na.rm)$thetastar,
             .025,na.rm=na.rm)}
ci.median.high <- function(x,na.rm=T) {
  quantile(bootstrap(1:length(x),1000,median.theta,x,na.rm=na.rm)$thetastar,
           .975,na.rm=na.rm) - median(x,na.rm=na.rm)}

na.mean <- function(x) {mean(x,na.rm=T)}
mean.theta <- function(x,xdata,na.rm=T) {mean(xdata[x],na.rm=na.rm)}
ci.mean.low <- function(x,na.rm=T) {
  mean(x,na.rm=na.rm) - 
    quantile(bootstrap(1:length(x),1000,mean.theta,x,na.rm=na.rm)$thetastar,
             .025,na.rm=na.rm)}
ci.mean.high <- function(x,na.rm=T) {
  quantile(bootstrap(1:length(x),1000,mean.theta,x,na.rm=na.rm)$thetastar,
           .975,na.rm=na.rm) - mean(x,na.rm=na.rm)}
```

### Sample aggregate analysis: sex differences in vocabulary development

Get by-child productive vocabulary data.
```{r}
num.words <- items %>%
  filter(form == "WS", type == "word") %>%
  group_by(language) %>%
  summarise(n = n())

vocab.admins <- admins %>%
  select(data_id, language, form, age, sex, production) %>%
  filter(form == "WS", !is.na(sex), sex != "")

vocab.data <- vocab.admins %>%
  group_by(language, sex, age) %>%
  left_join(num.words) %>%
  mutate(production = as.numeric(production)/n) %>%
  summarise_each(funs(na.median, ci.median.low, ci.median.high), production)

vocab.sample.sizes <- vocab.admins %>%
  group_by(language) %>%
  summarise(n = length(unique(data_id)))
vocab.data %<>% left_join(vocab.sample.sizes)
vocab.data %<>% mutate(label = sprintf("%s (n = %s)", language, n))
```

What these data look like for a given age:
```{r, echo=FALSE}
kable(filter(select(vocab.data, -label, -n), age==24),
      col.names = c("language", "sex", "age", "median", "confidence interval (lower)",
                    "confidence interval (upper)"),
      align = c("l", "c", "c", "c", "c", "c"),
      digits = 3)
```

Plot median productive vocabulary as a function of age.
```{r, fig.height=12, fig.width=10}
ggplot(vocab.data,
       aes(x=age, y=na.median, colour=sex, label=sex)) +
  facet_wrap(~ label, ncol = 3) +
  geom_pointrange(aes(ymin = na.median-ci.median.low,
                      ymax = na.median+ci.median.high),
                  size = .8,
                  show_guide = FALSE) +
  geom_line(size=1) +
  scale_x_continuous(breaks = seq(min(vocab.data$age), max(vocab.data$age), 2),
                     limits = c(min(vocab.data$age), max(vocab.data$age) + 1),
                     name = "\nAge (months)") +
  scale_y_continuous(name = "Median Productive Vocabulary (proportion of total words)\n",
                     limits=c(0,1)) +
  scale_color_manual(values = c("#2c7bb6", "#d7191c")) +
  theme_bw(base_size=14) +
  theme(legend.position="none",
        text=element_text(family=font)) +
  geom_dl(method = list(dl.trans(x=x +.2), "last.qp", cex=1, fontfamily=font))
```

### Sample by-item analysis: trajectories of color words

Set up color terms of each language.
```{r}
colors.key <- c("red", "orange", "yellow", "green", "blue", "black", "white", "brown")

colors <- list("Cantonese" = c("紅", "橙(色)", "黃", "綠", "藍", "黑", "白", "啡"), # 灰(grey)
               "Croatian" = c("crvena", "narančasta", "žuta", "zelena", "plava", "crn", "bijela", "smeđe"),
               "Danish" = c("rød", "orange", "gul", "grøn", "blå", "sort", "hvid", "brun"),
               "English" = c("red", "orange (description)", "yellow", "green", "blue", "black", "white", "brown"),
               "German" = c("rot", "orange", "gelb", "grün", "blau", "schwarz", "weiß", "braun"),
               "Italian" = c("rosso", "arancione", "giallo", "verde", "blu", "nero", "bianco", "marrone"),
               "Mandarin" = c("red", "", "yellow", "green", "blue", "black", "white", ""),
               "Norwegian" = c("rød", "oransje", "gul", "grønn" ,"blå", "svart", "hvit", "brun"),
               "Russian" = c("красный", "оранжевый", "желтый", "зеленый", "синий", "черный", "белый", "коричневый"),
               "Spanish" = c("rojo", "", "amarillo", "verde", "azul", "negro", "blanco", ""), # rosa morado
               "Swedish" = c("röd", "orange", "gul", "grön", "blå", "svart", "vit", "brun"),
               "Turkish" = c("Kırmızı", "Turuncu", "Sarı", "Yeşil", "", "Siyah", "Beyaz", "Kahverengi")) # Mor
```

Function for getting color data for a given language.
```{r}
get.language.data <- function(lang) {
  
  lang.table <- filter(instrument.tables, language==lang, form=="WS")$table[[1]]
  
  lang.colors <- colors[[lang]]
  lang.items <- select(filter(items, language==lang, form=="WS"),
                       definition, item.id)
  lang.color.items <- data.frame(color = colors.key, definition = lang.colors,
                                 stringsAsFactors = FALSE) %>%
    filter(definition != "") %>%
    left_join(lang.items)
  
  lang.data <- get.instrument.data(lang.table, lang.color.items$item.id) %>%
    mutate(language = lang,
           item.id = paste("item_", item.id, sep="")) %>%
    left_join(lang.color.items)
  
  return(lang.data)
  
  }
```

Load color data for each language and put it all together.
```{r}
languages <- names(colors)
color.data <- bind_rows(sapply(languages, get.language.data, simplify=FALSE))

color.byage.data <- color.data %>%
  inner_join(filter(admins, form == "WS")) %>%
  group_by(language, color, age) %>%
  mutate(produces = value == "produces") %>%
  summarise_each(funs(na.mean, ci.mean.high, ci.mean.low), produces)

sample_sizes <- color.data %>%
  group_by(language) %>%
  summarise(n = length(unique(data_id)))
color.byage.data %<>% left_join(sample_sizes)
color.byage.data %<>% mutate(label = sprintf("%s (n = %s)", language, n))
```

What these data look like for a given age and language:
```{r, echo=FALSE}
kable(filter(select(color.byage.data, -label, -n), language=="English", age==24),
      col.names = c("language", "color", "age", "median", "confidence interval (lower)",
                    "confidence interval (upper)"),
      align = c("l", "l", "c", "c", "c", "c"),
      digits = 3)
```

Plot the proportion of kids that produce each color as a function of their age.
```{r, fig.height=12, fig.width=10}
ggplot(color.byage.data, aes(x=age, y=na.mean, color=color, label=color)) +
  facet_wrap(~ label, ncol = 3) +
  geom_pointrange(aes(ymin = na.mean-ci.mean.low,
                      ymax = na.mean+ci.mean.high),
                  size = .5,
                  show_guide = FALSE) +
  geom_line(size=.8) +
  theme_bw(base_size=14) +
  theme(legend.position="none",
        text=element_text(family=font)) +
  geom_dl(method = list(dl.trans(x=x +.2), "last.qp", cex=.7, fontfamily=font)) +
                                # black blue brown green orange red white yellow
  scale_color_manual(values = c("black", "#2c7bb6", "brown", "#1a9641", "orange", "#d7191c", "gray87", "gold1")) +
  scale_x_continuous(breaks = seq(min(color.byage.data$age), max(color.byage.data$age), 2),
                     limits = c(min(color.byage.data$age), max(color.byage.data$age) + 3),
                     name = "\nAge (months)") +
  scale_y_continuous(name = "Proportion of Children Producing\n",
                     limits = c(0,1))
```