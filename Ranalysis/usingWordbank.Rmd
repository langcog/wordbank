---
title: "Accessing the Wordbank Database"
author: "Dan Yurovsky and Mika Braginsky"
date: "March 03, 2015"
output: 
  html_document:
  highlight: tango
  theme: spacelab
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(message=FALSE, warning=FALSE, cache=TRUE)
```

Load Required Libraries
```{r, message=FALSE,cache=FALSE}
#load libraries for data manipulation and graphing
library(dplyr)
library(directlabels)
library(RMySQL)
library(tidyr)
library(stringr)
library(bootstrap)
library(ggplot2)

source('../shiny_apps/data_loading.R')

```

Load in Database Tables
```{r, message=FALSE}
## Open database connection
#"54.200.225.86"
wordbank <- src_mysql(dbname='wordbank',host="54.149.39.46", 
                      user="wordbank",password="wordbank")

common.tables <- get.common.tables(wordbank)
kable(data.frame(common.tables = names(common.tables)))

admins <- get.administration.data(common.tables$momed,
                                  common.tables$child,
                                  common.tables$instrumentsmap,
                                  common.tables$administration) %>%
  filter(!is.na(sex), form == "WS", age >= 16, age <= 30)

items <- get.item.data(common.tables$wordmapping,
                       common.tables$instrumentsmap)
```

```{r, message=FALSE}
## Functions for bootstrapping 95% confidence intervals
na.median <- function(x) {median(x,na.rm=T)}
theta <- function(x,xdata,na.rm=T) {median(xdata[x],na.rm=na.rm)}
ci.low <- function(x,na.rm=T) {
  median(x,na.rm=na.rm) - 
    quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,
             .025,na.rm=na.rm)}
ci.high <- function(x,na.rm=T) {
  quantile(bootstrap(1:length(x),1000,theta,x,na.rm=na.rm)$thetastar,
           .975,na.rm=na.rm) - median(x,na.rm=na.rm)}

num.words <- items %>%
  filter(type == "word") %>%
  group_by(language) %>%
  summarise(n = n())

vocab.data <- admins %>%
  group_by(language, sex, age) %>%
  left_join(num.words) %>%
  mutate(production = as.numeric(production)/n) %>%
  summarise_each(funs(na.median,ci.low,ci.high),production) %>%
  ungroup()%>%
  arrange(age,language,sex)

#Show productive vocabulary estimates
kable(head(vocab.data))
```

Plot Median Productive Vocabularies
```{r, message=FALSE,fig.height=8,fig.width=9}
ggplot(vocab.data,
       aes(x=age, y=na.median,colour=sex,label=sex))+
  facet_wrap(~ language) +
  geom_pointrange(aes(ymin = na.median-ci.low,
                      ymax = na.median+ci.high),
                  size = .8,
                  show_guide = FALSE) +
  geom_line(size=1) +
  scale_x_continuous(breaks=seq(16,30,2),limits=c(16,31),
                     name = "Age (months)")+
  scale_y_continuous(name = "Median Productive Vocab. Prop.",
                     limits=c(0,1)) +
  theme_bw(base_size=14) +
  theme(legend.position="none", panel.grid=element_blank()) +
  geom_dl(method = list(dl.trans(x=x +.2),"last.qp",cex=1)) +
  scale_color_manual(values = c("#e41a1c","#377eb8"))
```


